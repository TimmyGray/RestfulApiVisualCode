<!DOCTYPE html>
<html style="height: 100%;">
<head>
    <meta charset="utf-8" />
    <meta name="clientview" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Происшествия</title>
    <link rel="stylesheet" type="text/css" href="bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/main.css">

</head>
<body id="body">

    <header class="p-3 text-white">
        <div class="container">
            <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start">
                <a href="#" class="d-flex align-items-center mb-2 mb-lg-0 text-white text-decoration-none">
                    <img src="Resources/warning-sign.svg" alt="" height="50" width="50">
                </a>

                <ul id="nav" class="nav col-12 col-lg-auto me-lg-auto mb-2 justify-content-center mb-md-0">
                    <li><a href="#" name="Create" class="nav-link px-2" id="CreateClick">Создать</a></li>
                    <li><a href="#" name="Histories" class="nav-link px-2" id="HistoryClick">История</a></li>
                    <li><a href="#" name="Faq" class="nav-link px-2" id="FaqClick">Бестиарий</a></li>
                </ul>

                <form class="col-12 col-lg-auto mb-3 mb-lg-0 me-lg-3">
                    <input type="search" class="form-control form-control-dark" placeholder="Искать..." aria-label="Search">
                </form>

                <div class="text-end">
                    <button type="button" class="btn btn-softyellow me-2">Войти</button>
                    <button type="button" class="btn btn-softbrown">Регистрация</button>
                </div>
            </div>
        </div>
    </header>

    <main id="Create" name="Create">
        <div class="container justify-content-center">
            <h1 id="FirstPage" style="text-align: center;">Карточка происшествия</h1>
        </div>
        <form name="eventForm" class="was was-validated" id="cardevent">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-md-6 col-lg-4 col-sm-6 col-12 mb-3">
                        <label for="nameofdevice">Устройство</label>
                        <select class="form-select d-block w-100 d-done" name="nameofdevice" required>
                            <option value>Выбрать...</option>
                            <option>SSL</option>
                            <option>Karrera</option>
                            <option>SoundCraft</option>
                            <option>Dalet</option>
                            <option>Микрофон, мониторинг, приемопередатчик</option>
                            <option>Platinum</option>
                            <option>Свет и оборудование</option>
                            <option>Декорации</option>
                            <option>Камеры и камерные каналы</option>
                            <option>Графические станции</option>
                            <option>Компьютер</option>
                            <option>Другое</option>
                        </select>
                        <div class="invalid-feedback">Необходимо указать устройство</div>
                    </div>
                    <div class="col-auto mb-3">
                        <label for="nameofasb">Номер АСБ</label>
                        <select class="form-select d-block w-100 d-done" name="nameofasb" required>
                            <option value>Выбрать...</option>
                            <option>1</option>
                            <option>3</option>
                            <option>4</option>
                            <option>5</option>
                            <option>6</option>
                            <option>7</option>
                            <option>8</option>
                        </select>
                        <div class="invalid-feedback">Необхоимо указать номер АСБ</div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 col-lg-4 col-sm-6 col-12 mb-3">
                        <div class="form-group">
                            <label for="eventdiscribe">Описание проблемы</label>
                            <textarea class="form-control" name="discribeevent" rows="3" required></textarea>
                        </div>
                        <div class="invalid-feedback">Заполните описание</div>

                    </div>
                    <div class="col-auto mb-3">
                        <div class="form-group">
                            <label for="fixdiscribe">Как исправили(если исправили)</label>
                            <textarea class="form-control" name="fixevent" rows="3"></textarea>
                        </div>

                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 col-lg-4 col-sm-6 col-12 mb-3">
                        <label for="dateofevent">Дата происшествия</label>
                        <div class="w-100"></div>
                        <input name="dateofevent" class="form-control" type="date" required />
                        <div class="invalid-feedback">Укажите дату происшествия</div>
                    </div>
                    <div class="col-auto mb-3">
                        <label for="isserios">Серьезность</label>
                        <select name="isserios" class="form-select d-block w-100 d-done" required>
                            <option value>Выбрать...</option>
                            <option>Серьезное происшествие</option>
                            <option>Несерьезное происшествие</option>
                        </select>
                        <div class="invalid-feedback">Укажите серьезность</div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-7 col-lg-7 col-sm-12 col-12">
                        <div class="input-group mb-3">
                            <label for="inputGroupFile">Фотография поломки</label>
                            <div class="w-100"></div>
                            <input type="file" class="form-control" id="inputGroupFile" aria-describedby="inputGroupFileAddon" aria-label="Загрузить">
                            <button class="btn btn-outline-softbrown" type="button" id="inputGroupFileAddon">Загрузить</button>
                        </div>
                    </div>

                </div>

                <div class="row">
                    <div class="col-md-6 col-lg-4 col-sm-6 col-6 mb-3">
                        <button id="submit" type="submit" class="btn btn-softyellow">Создать</button>
                    </div>
                    <div class="col-auto mb-3">
                        <button id="reset" type="reset" class="btn btn-softyellow">Сброс</button>
                    </div>

                </div>


            </div>
        </form>


    </main>

    <main id="Histories" name="Histories" class="disactivetab">


        <div class="container justify-content-center">
            <h1 id="SecondPage" style="text-align: center;">История происшествий</h1>
        </div>
        
        <div class="container-fluid">
            <div class="row">
                <div class="col-auto">
                    <select id="Sorting" class="form-select" hidden>
                        <option id="val" value></option>
                    </select>

                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead style="background-color: lightcoral;">
                        <tr id="sorttr">
                            <th id="#">#</th>
                            <th id="Date">Дата события</th>
                            <th id="Number">Номер АСБ</th>
                            <th id="Device">Устройство</th>
                            <th id="Serios">Серезность</th>
                            <th id="Delete"></th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            <div class="modal fade" id="Modal" tabindex="-1" aria-labelledby="ModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h6 id="idh" hidden></h6>
                            <h5 class="modal-title" id="ModalLabel"></h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>

                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-6">
                                    <textarea class="form-control" rows="3" id="discribe"></textarea>
                                </div>
                                <div class="col-6">
                                    <textarea class="form-control" rows="3" id="fix"></textarea>
                                </div>
                            </div>

                        </div>
                        <div class="modal-footer">
                            <button type="button" id="savechanges" class="btn btn-softyellow">Сохранить изменения</button>
                            <button type="button" id="closechanges" class="btn btn-softyellow" data-bs-dismiss="modal">Закрыть</button>

                        </div>

                    </div>

                </div>

            </div>
        </div>

    </main>

    <main id="Faq" name="Faq" class="disactivetab">

    </main>
    <script src="bootstrap/dist/js/bootstrap.bundle.min.js" integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ" crossorigin="anonymous"></script>
    <script>
        const idsort = document.getElementById("#");
        const datesort = document.getElementById("Date");
        const numbersort = document.getElementById("Number");
        const devicesort = document.getElementById("Device");
        const seriossort = document.getElementById("Serios");

        idsort.addEventListener("click", Sorting);
        datesort.addEventListener("click", Sorting);
        numbersort.addEventListener("click", Sorting);
        devicesort.addEventListener("click", Sorting);
        seriossort.addEventListener("click", Sorting);

        function Sorting(event) {
            const sort = event.currentTarget;
            const sorting = document.getElementById("Sorting");
            const val = document.getElementById("val");
            val.textContent = sort.textContent;
            sorting.hidden = false;
        }
 
        const idh = document.getElementById("idh");
        const Label = document.getElementById("ModalLabel");
        const discribe = document.getElementById("discribe");
        const fix = document.getElementById("fix");
        var tempevent;

        const editbut = document.getElementById("savechanges");
        editbut.addEventListener("click", function (e) {
            tempevent.discribeevent = discribe.value;
            tempevent.fixevent = fix.value;
            tempevent.id = idh.textContent;
            EditEvent(tempevent.id, tempevent.dateofevent, tempevent.nameofasb, tempevent.nameofdevice, tempevent.isserios, tempevent.discribeevent, tempevent.fixevent);
            closebut.click();
        });


        const closebut = document.getElementById("closechanges");
        closebut.addEventListener("click", function (e) {
            alert("closechanges");
        });


        const tablinks = document.getElementsByClassName("nav-link px-2");

        function change(event) {
            const maintabs = document.getElementsByTagName("main");

            for (var i = 0; i < maintabs.length; i++) {
                maintabs[i].className = "disactivetab";
            }

            document.getElementById(event.currentTarget.name).className = "";
            if (event.currentTarget.name === Histories) {
                row();
            }

        }

        for (var i = 0; i < tablinks.length; i++) {
            tablinks[i].onclick = change;
        }

        function row(event) {

            const tr = document.createElement("tr");

            tr.id = event.id;
            tr.setAttribute("data-rowid", event.id);

            const idTd = document.createElement("td");
            idTd.setAttribute("name", "id");
            idTd.setAttribute("data-bs-toggle", "modal");
            idTd.setAttribute("data-bs-target", "#Modal");
            idTd.append(event.id);
            tr.append(idTd);

            const dateofeventTd = document.createElement("td");
            dateofeventTd.setAttribute("name", "dateofevent");
            dateofeventTd.setAttribute("data-bs-toggle", "modal");
            dateofeventTd.setAttribute("data-bs-target", "#Modal");
            dateofeventTd.append(event.dateofevent);
            tr.append(dateofeventTd);

            const nameofasbTd = document.createElement("td");
            nameofasbTd.setAttribute("name", "nameofasb");
            nameofasbTd.setAttribute("data-bs-toggle", "modal");
            nameofasbTd.setAttribute("data-bs-target", "#Modal");
            nameofasbTd.append(event.nameofasb);
            tr.append(nameofasbTd);

            const nameofdeviceTd = document.createElement("td");
            nameofdeviceTd.setAttribute("name", "nameofdevice");
            nameofdeviceTd.setAttribute("data-bs-toggle", "modal");
            nameofdeviceTd.setAttribute("data-bs-target", "#Modal");
            nameofdeviceTd.append(event.nameofdevice);
            tr.append(nameofdeviceTd);

            const isseriosTd = document.createElement("td");
            isseriosTd.setAttribute("name", "isserios");
            isseriosTd.setAttribute("data-bs-toggle", "modal");
            isseriosTd.setAttribute("data-bs-target", "#Modal");
            isseriosTd.append(event.isserios);
            tr.append(isseriosTd);

            const delbutTd = document.createElement("td");
            delbutTd.setAttribute("name", "delbutTd");
            const delbut = document.createElement("a");
            delbut.href = "#";
            delbut.className = "d-flex align-items-center mb-2 mb-lg-0";
            const delbutimg = document.createElement("img");
            delbutimg.src = "Resources/recyclebin.png";
            delbutimg.alt = "";
            delbutimg.height = "50";
            delbutimg.width = "50";
            
            delbut.append(delbutimg);
            delbut.addEventListener("click", function (e) {
                DeleteEvent(event.id);
            });
            

            delbutTd.append(delbut);
            
            tr.appendChild(delbutTd);
           
            tr.addEventListener("click", trclick);

         

            return tr;
        }

        function trclick(event) {
            const curtr = event.currentTarget;
            GetEvent(curtr.id);
        }

        async function EditEvent(eventId, eventDateofevent, eventNameofasb, eventNameofdevice, eventIsserios, eventDiscribeevent, eventFixevent) {
            const response = await fetch("api/events", {
                method: "PUT",
                headers: { "Accept": "application/json", "Content-Type": "application/json" },
                body: JSON.stringify({
                    id: parseInt(eventId, 10),
                    dateofevent: eventDateofevent,
                    nameofasb: eventNameofasb,
                    nameofdevice: eventNameofdevice,
                    isserios: eventIsserios,
                    discribeevent: eventDiscribeevent,
                    fixevent: eventFixevent
                })
            });
            if (response.ok === true) {
                const event = await response.json();
                const temptr = document.getElementById(event.id);
                temptr.replaceWith(row(event));
                alert("Происшествие обновлено");

            }

        }

        async function CreateEvent(eventDateofevent, eventNameofasb, eventNameofdevice, eventIsserios, eventDiscribeevent, eventFixevent) {
            const response = await fetch("api/events", {
                method: "POST",
                headers: { "Accept": "application/json", "Content-Type": "application/json" },
                body: JSON.stringify({
                    dateofevent: eventDateofevent,
                    nameofasb: parseInt(eventNameofasb, 10),
                    nameofdevice: eventNameofdevice,
                    isserios: eventIsserios,
                    discribeevent: eventDiscribeevent,
                    fixevent: eventFixevent
                })
            });
            if (response.ok === true) {
                const event = await response.json();
                document.querySelector("tbody").append(row(event));

            }
        }


        document.forms["eventForm"].addEventListener("submit", e => {
            e.preventDefault();
            alert("начало");
            const form = document.forms["eventForm"];
            const dateofevent = form.elements["dateofevent"].value;
            const nameofasb = form.elements["nameofasb"].value;
            const nameofdevice = form.elements["nameofdevice"].value;
            const isserios = form.elements["isserios"].value;
            const discribeevent = form.elements["discribeevent"].value;
            const fixevent = form.elements["fixevent"].value;
            CreateEvent(dateofevent, nameofasb, nameofdevice, isserios, discribeevent, fixevent);
            form.reset();

        });

        async function GetEvent(id) {
            const response = await fetch("/api/events/" + id, {
                method: "GET",
                headers: { "Accept": "application/json" }
            });
            if (response.ok === true) {
                const event = await response.json();
                tempevent = event;
                idh.textContent = event.id;
                Label.textContent = event.nameofdevice;
                discribe.value = event.discribeevent;
                fix.value = event.fixevent;
            }
        }

        async function GetEvents() {

            const response = await fetch("/api/events", {
                method: "GET",
                headers: { "Accept": "application/json" }
            });

            if (response.ok === true) {

                const events = await response.json();
                let rows = document.querySelector("tbody");
                events.forEach(event => {

                    rows.append(row(event));
                });
            }
        }

        async function DeleteEvent(id) {
            const response = await fetch("/api/events/" + id, {
                method: "DELETE",
                headers: { "Accept": "application/json" }
            });
            if (response.ok === true) {
                const event = await response.json();
                document.querySelector("tr[data-rowid='" + event.id + "']").remove();
                alert("delete suc");
            }
        }

        GetEvents();


    </script>

</body>
</html>