<!DOCTYPE html> 
<html style="height: 100%;">
    <head>
        <meta charset="utf-8"/>
        <meta name="clientview" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <title>Происшествия</title>
        <link rel="stylesheet" type="text/css" href="bootstrap/dist/css/bootstrap.min.css">
        <link rel="stylesheet" type="text/css" href="css/main.css">
      
    </head>
    <body id="body">
        <header class="p-3 text-white">
            <div class="container">
              <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start">
                <a href="#" class="d-flex align-items-center mb-2 mb-lg-0 text-white text-decoration-none">
                  <img src="Resources/warning-sign.svg" alt="" height="50" width="50">
                </a>

                <ul class="nav col-12 col-lg-auto me-lg-auto mb-2 justify-content-center mb-md-0">
                  <li><a href="#" class="nav-link px-2" id="CreateClick" onclick="changetocreate(event,'CreateMain')">Создать</a></li>
                  <li><a href="#" class="nav-link px-2" id="HistoryClick" onclick="changetohistories(event,'HistoriesMain')">История</a></li>
                  <li><a href="#" class="nav-link px-2" id="FaqClick">Бестиарий</a></li>
                </ul>
        
                <form class="col-12 col-lg-auto mb-3 mb-lg-0 me-lg-3">
                  <input type="search" class="form-control form-control-dark" placeholder="Искать..." aria-label="Search">
                </form>
        
                <div class="text-end">
                  <button type="button" class="btn btn-softyellow me-2">Войти</button>
                  <button type="button" class="btn btn-softbrown">Регистрация</button>
                </div>
              </div>
            </div>
          </header>
          
          <main id = "CreateMain" class="maintab">
              <div class="container justify-content-center">
                <h1 id="FirstPage" style="text-align: center;">Карточка происшествия</h1>
              </div>
              <form name="eventForm" class="was was-validated" id="cardevent">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-md-6 col-lg-4 col-sm-6 col-12 mb-3"> 
                            <label for="nameofdevice">Устройство</label>
                            <select class="form-select d-block w-100 d-done" name="nameofdevice" required>
                                <option value>Выбрать...</option>
                                <option>SSL</option>
                                <option>Karrera</option>
                                <option>SoundCraft</option>
                                <option>Dalet</option>
                                <option>Микрофон, мониторинг, приемопередатчик</option>
                                <option>Platinum</option>
                                <option>Свет и оборудование</option>
                                <option>Декорации</option>
                                <option>Камеры и камерные каналы</option>
                                <option>Графические станции</option>
                                <option>Компьютер</option>
                                <option>Другое</option>
                            </select>
                            <div class="invalid-feedback">Необходимо указать устройство</div>
                        </div>
                        <div class="col-auto mb-3">
                            <label for="nameofasb">Номер АСБ</label>
                            <select class="form-select d-block w-100 d-done" name="nameofasb" required>
                                    <option value>Выбрать...</option>
                                    <option>1</option>
                                    <option>3</option>
                                    <option>4</option>
                                    <option>5</option>
                                    <option>6</option>
                                    <option>7</option>
                                    <option>8</option>
                            </select>
                            <div class="invalid-feedback">Необхоимо указать номер АСБ</div>
                        </div>            
                    </div>

                    <div class="row">
                        <div class="col-md-6 col-lg-4 col-sm-6 col-12 mb-3">
                            <div class="form-group">
                                <label for="eventdiscribe">Описание проблемы</label>
                                <textarea class="form-control" name="eventdiscribe" rows="3" required></textarea>
                            </div>
                            <div class="invalid-feedback">Заполните описание</div>
    
                        </div>
                        <div class="col-auto mb-3">
                            <div class="form-group">
                                <label for="fixdiscribe">Как исправили(если исправили)</label>
                                <textarea class="form-control" name="fixdiscribe" rows="3"></textarea>
                            </div>
    
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 col-lg-4 col-sm-6 col-12 mb-3">                            
                            <label for="dateofevent">Дата происшествия</label>
                            <div class="w-100"></div>
                            <input name="dateofevent" class="form-control" type="date" required/>
                            <div class="invalid-feedback">Укажите дату происшествия</div>
                        </div>
                        <div class="col-auto mb-3">
                            <label for="isserios">Серьезность</label>
                            <select name="isserios" class="form-select d-block w-100 d-done" required>
                                    <option value>Выбрать...</option>
                                    <option>Серьезное происшествие</option>
                                    <option>Несерьезное происшествие</option>
                            </select>
                            <div class="invalid-feedback">Укажите серьезность</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-7 col-lg-7 col-sm-12 col-12">
                            <div class="input-group mb-3">
                                <label for="inputGroupFile">Фотография поломки</label>
                                <div class="w-100"></div>
                                <input type="file" class="form-control" id="inputGroupFile" aria-describedby="inputGroupFileAddon" aria-label="Загрузить">
                                <button class="btn btn-outline-softbrown" type="button" id="inputGroupFileAddon">Загрузить</button>
                            </div>
                        </div>
                        
                    </div>

                    <div class="row">
                        <div class="col-md-6 col-lg-4 col-sm-6 col-6 mb-3">
                            <button id="submit" type="submit" class="btn btn-softyellow">Создать</button>
                        </div>
                        <div class="col-auto mb-3">
                            <a id="reset" class="btn btn-softyellow">Сброс</a>
                        </div>
                        
                    </div>

                    
                </div>
              </form>
            
            </main>

            <main id="HistoriesMain" class="maintab">

                <div class="table-responsive"> 
                    <table class="table table-striped table-hover">
                        <thead style="background-color: lightcoral;">
                            <tr>
                                <th>#</th>
                                <th>Дата события</th>
                                <th>Номер АСБ</th>
                                <th>Устройство</th>
                                <th>Серезность</th>
                                
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>

            </main>
            
            <main id="FaqMain" class="maintab">

            </main>
            <script src="Styles/bootstrap/dist/js/bootstrap.bundle.min.js" integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ" crossorigin="anonymous"></script>    
            <script>
                function changetohistories(){

                    const body = document.getElementById("body");

                    const newmain = document.document.createElement("main");

                    const newdiv = document.createElement("div");
                    newdiv.className = "container justify-content-center";

                    const newh1 = document.createElement("h1");
                    newh1.textContent = "Происшествия";
                    newh1.style = "text-align: center;";

                    newdiv.appendChild(newh1);
                    
                    newmain.appendChild(newdiv);

                    const newcont = document.createElement("div");
                    newcont.className = "table-responsive";

                    const newtable = document.createElement("table");
                    newtable.className = "table table-striped table-hover";

                    const newthead = document.createElement("thead");
                    newthead.style = "background-color: lightcoral;";

                    const newtr = document.createElement("tr");

                    const newth1 = document.createElement("th");
                    newth1.textContent = "#";

                    const newth2 = document.createElement("th");
                    newth2.textContent = "Дата происшествия";

                    const newth3 = document.createElement("th");
                    newth3.textContent = "Номер АСБ";

                    const newth4 = document.createElement("th");
                    newth4.textContent = "Название устройства";

                    const newth5 = document.createElement("th");
                    newth5.textContent = "Серьезность";

                    const newtbody = document.createElement("tbody");

                    newtr.appendChild(newth1);
                    newtr.appendChild(newth2);
                    newtr.appendChild(newth3);
                    newtr.appendChild(newth4);
                    newtr.appendChild(newth5);

                    newthead.appendChild(newtr);

                    newtable.appendChild(newthead);

                    newtable.appendChild(newtbody);

                    newcont.appendChild(newtable);

                    newmain.appendChild(newcont);

                    const oldmain = document.getElementById("CreateMain");
                    
                    body.replaceChild(newmain,oldmain);
                    
                   /*  const newnav1 = document.getElementById("item1");
                    newnav1.className = "nav-item"
                    const newlink1 = document.getElementById("changetocard");
                    newlink1.style = "font-size: smaller;color: crimson; background-color: rgb(247, 229, 226)";

                    const newnav2 = document.getElementById("item2");
                    newnav2.className = "nav-item active";
                    const newlink2 = document.getElementById("changetohistory");
                    newlink2.style = "font-size: smaller;background-color: lightcoral;";

                    const newsearch = document.createElement("form");
                    newsearch.className = "form-inline my-2 my-lg-0"
                    const newinput = document.createElement("input");
                    newinput.className = "form-control mr-sm-2";
                    newinput.style = "search";
                    newinput.placeholder = "Найти";
                    newinput.ariaLabel = "Найти";
                    const newsearchbut = document.createElement("button");
                    newsearchbut.className = "btn btn-outline-success my-2 my-sm-0";
                    newsearchbut.type = "submit";
                    newsearchbut.textContent = "Поиск";
                    newsearch.appendChild(newinput);
                    newsearch.appendChild(newsearchbut);
                    const newnavbarnav = document.getElementById("navbarNav");
                    newnavbarnav.appendChild(newsearch); */


                    GetEvents();
                }
                
                const createbut = document.getElementById("CreateClick");
                changebut.addEventListener("click",changetocreate);

                const historybut = document.getElementById("HistoryClick");
                historybut.addEventListener("click",changetohistories);

                const faqbut = document.getElementById("FaqClick");
                faqbut.addEventListener("click",changetofaq);
                 function row(event) {
     
                    const tr = document.createElement("tr");
                    tr.setAttribute("data-rowid", event.id);

                    const idTd = document.createElement("td");
                    idTd.append(event.id);
                    tr.append(idTd);

                    const dateofeventTd = document.createElement("td");
                    dateofeventTd.append(event.dateofevent);
                    tr.append(dateofeventTd);

                    const nameofasbTd = document.createElement("td");
                    nameofasbTd.append(event.nameofasb);
                    tr.append(nameofasbTd);

                    const nameofdeviceTd = document.createElement("td");
                    nameofdeviceTd.append(event.nameofdevice);
                    tr.append(nameofdeviceTd);

                    const isseriosTd = document.createElement("td");
                    isseriosTd.append(event.isserios);
                    tr.append(isseriosTd);
                    return tr;
                }

                         

               async function CreateEvent(eventDateofevent,eventNameofasb, eventNameofdevice, eventIsserios) {
                    const response = await fetch("api/events", {
                        method: "POST",
                        headers: { "Accept": "application/json", "Content-Type": "application/json" },
                        body: JSON.stringify({
                            dateofevent: eventDateofevent,
                            nameofasb: parseInt(eventNameofasb, 10),
                            nameofdevice: eventNameofdevice,
                            isserios: eventIsserios
                            

                        })
                    });
                    if (response.ok === true) {
                        const event = await response.json();                  
                        reset();
                        document.querySelector("tbody").append(row(event));
                    }
                }

                function reset() {
                    const form = document.forms["eventForm"];
                    form.reset();
                    form.elements["id"].value = 0;
                    
                } 

                const resetbut = document.getElementById("reset");
                resetbut.onclick = function(e){
                    e.preventDefault();
                    reset();
                }

                document.forms["eventForm"].addEventListener("submit", e => {
                    e.preventDefault();
                    const form = document.forms["eventForm"];
                    const id = form.elements["id"].value;
                    const dateofevent = form.elements["dateofevent"].value;
                    const nameofasb = form.elements["nameofasb"].value;
                    const nameofdevice = form.elements["nameofdevice"].value;
                    const isserios = form.elements["isserios"].value;
                    CreateEvent(dateofevent, nameofasb, nameofdevice, isserios);
                    alert("Происшествие создано");   
                });

                GetEvents();
         
                async function GetEvents() {
                    
                    const response = await fetch("/api/events", {
                        method: "GET",
                        headers: { "Accept": "application/json" }
                    });
                    
                    if (response.ok === true) {
                        
                        const events = await response.json();
                        let rows = document.querySelector("tbody"); 
                        events.forEach(event => {
                            
                            rows.append(row(event));
                        });
                    }
                }
                
                async function GetEvent(id) {
                const response = await fetch("/api/events/" + id, {
                    method: "GET",
                    headers: { "Accept": "application/json" }
                });
                if (response.ok === true) {
                    const event = await response.json();
                    const form = document.forms["eventForm"];
                    form.elements["id"].value = event.id;
                    form.elements["dateofevent"].value = event.dateofevent;
                    form.elements["nameofasb"].value = event.nameofasb;
                    form.elements["nameofdevice"].value = event.nameofdevice;
                    form.elements["isserios"].value = event.isserios;
                }
            }
            
         
            </script>

        </div>
    </body>
</html>