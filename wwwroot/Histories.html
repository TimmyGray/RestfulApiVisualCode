<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <meta name="clientview" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="stylesheet" href="Styles/mystyles.css">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">        
        <title>История</title>
        <link rel="stylesheet" href="https://bootstraptema.ru/plugins/2015/bootstrap3/bootstrap.min.css" />
        <script src="https://bootstraptema.ru/plugins/jquery/jquery-1.11.3.min.js"></script>
        <script type="text/javascript" src="https://bootstraptema.ru/plugins/2015/b-v3-3-6/bootstrap.min.js"></script>
        <script src="https://bootstraptema.ru/_sf/3/393.js"></script>
        <link rel="stylesheet" href="Styles/calendar.css">
    </head>
    <body class="bg-light">
        
        <div class=" container">  
            <img src="Resources/warning-sign.svg" class="d-block mx-auto" alt width="96" height="96">         
            <nav class="navbar navbar-expand navbar-light bg-light">
                <div class="collapse navbar-collapse" id="navbarNav">
                  <ul class="nav nav-pills" style="justify-content: flex-start;">
                    <li class="nav-item col-md-3 col-6">
                      <a class="nav-link" href="ClientView.html" style="font-size: small;color: crimson;">Карточка происшествия<span class="sr-only">(current)</span></a>
                    </li>
                    <li class="nav-item active col-md-3 col-4">
                      <a class="nav-link" href="Histories.html" style="font-size: small;background-color: lightcoral;">История происшествий</a>
                    </li> 
                  </ul>
                </div>
            </nav>      
            <h1>Происшествия</h1>
                
           <!--  <form name="eventForm" class="was was-validated">
                <input type="hidden" name="id" value="0" />
                <div class="row">
                    <div class="col-md-6 col-lg-4 col-sm-6 col-12 mb-3"> 
                        <label for="nameofdevice">Устройство</label>
                        <select class="custom-select d-block w-100 d-done" name="nameofdevice" required>
                            <option value>Выбрать...</option>
                            <option>SSL</option>
                            <option>Karrera</option>
                            <option>SoundCraft</option>
                            <option>Dalet</option>
                            <option>Микрофон, мониторинг, приемопередатчик</option>
                            <option>Platinum</option>
                            <option>Свет и оборудование</option>
                            <option>Декорации</option>
                            <option>Камеры и камерные каналы</option>
                            <option>Графические станции</option>
                            <option>Компьютер</option>
                            <option>Другое</option>
                        </select>
                        <div class="invalid-feedback">Необходимо указать устройство</div>
                    </div>
                    <div class="col-auto mb-3">
                        <label for="nameofasb">Номер АСБ</label>
                        <select class="custom-select d-block w-100 d-done" name="nameofasb" required>
                                <option value>Выбрать...</option>
                                <option>1</option>
                                <option>3</option>
                                <option>4</option>
                                <option>5</option>
                                <option>6</option>
                                <option>7</option>
                                <option>8</option>
                        </select>
                        <div class="invalid-feedback">Необхоимо указать номер АСБ</div>
                    </div>            
                </div>
                <div class="row">
                    <div class="col-md-6 col-lg-4 col-sm-6 col-12 mb-3">
                        <div class="form-group">
                            <label for="eventdiscribe">Описание проблемы</label>
                            <textarea class="form-control" name="eventdiscribe" rows="3" required></textarea>
                        </div>
                        <div class="invalid-feedback">Заполните описание</div>

                    </div>
                    <div class="col-auto mb-3">
                        <div class="form-group">
                            <label for="fixdiscribe">Как исправили(если исправили)</label>
                            <textarea class="form-control" name="fixdiscribe" rows="3"></textarea>
                        </div>

                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 col-lg-4 col-sm-6 col-12 mb-3">                            
                        <label for="dateofevent">Дата происшествия</label>
                        <div class="w-100"></div>
                        <input name="dateofevent" class="custom day" type="date" required/>
                        <div class="invalid-feedback">Укажите дату происшествия</div>
                    </div>
                    <div class="col-auto mb-3">
                        <label for="isserios">Серьезность</label>
                        <select name="isserios" class="custom-select d-block w-100 d-done" required>
                                <option value>Выбрать...</option>
                                <option>Серьезное происшествие</option>
                                <option>Несерьезное происшествие</option>
                        </select>
                        <div class="invalid-feedback">Укажите серьезность</div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 col-lg-4 col-sm-6 col-12 mb-3">
                        <label for="fileinput">Фотография поломки</label>
                        <div class="custom-file"> 
                            <input type="file" class="custom-file-input" name="fileinput">
                            <label class="custom-file-label" for="fileinput">Загрузить файл...</label>
                        </div>
                    </div>   
                </div>
                <div class="row">
                    <div class="col-md-6 col-lg-4 col-sm-6 col-12 mb-3">
                        <button id="submit" type="submit" class="btn btn-danger">Создать</button>
                    </div>
                    <div class="col-auto mb-3">
                        <a id="reset" class="btn btn-danger">Сброс</a>
                    </div>
                    
                </div>
            </form> -->
            <div class="table-responsive"> 
                <table class="table table-striped table-hover">
                    <thead style="background-color: lightcoral;">
                        <tr>
                            <th>#</th>
                            <th>Дата события</th>
                            <th>Номер АСБ</th>
                            <th>Устройство</th>
                            <th>Серезность</th>
                            
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            
            
            <script>
                GetEvents();
         
                async function GetEvents() {
                    // отправляет запрос и получаем ответ
                    const response = await fetch("/api/events", {
                        method: "GET",
                        headers: { "Accept": "application/json" }
                    });
                    // если запрос прошел нормально
                    if (response.ok === true) {
                        // получаем данные
                        const events = await response.json();
                        let rows = document.querySelector("tbody"); 
                        events.forEach(event => {
                            // добавляем полученные элементы в таблицу
                            rows.append(row(event));
                        });
                    }
                }
                // Получение одного пользователя
                async function GetEvent(id) {
                const response = await fetch("/api/events/" + id, {
                    method: "GET",
                    headers: { "Accept": "application/json" }
                });
                if (response.ok === true) {
                    const event = await response.json();
                    const form = document.forms["eventForm"];
                    form.elements["id"].value = event.id;
                    form.elements["dateofevent"].value = event.dateofevent;
                    form.elements["nameofasb"].value = event.nameofasb;
                    form.elements["nameofdevice"].value = event.nameofdevice;
                    form.elements["isserios"].value = event.isserios;
                }
            }
                // Добавление пользователя
                async function CreateEvent(eventDateofevent,eventNameofasb, eventNameofdevice, eventIsserios) {
         
                    const response = await fetch("api/events", {
                        method: "POST",
                        headers: { "Accept": "application/json", "Content-Type": "application/json" },
                        body: JSON.stringify({
                            dateofevent: eventDateofevent,
                            nameofasb: parseInt(eventNameofasb, 10),
                            nameofdevice: eventNameofdevice,
                            isserios: eventIsserios
                            

                        })
                    });
                    if (response.ok === true) {
                        const event = await response.json();                  
                        reset();
                        document.querySelector("tbody").append(row(event));
                    }
                }
                // Изменение пользователя
                async function EditEvent(eventId, eventDateofevent, eventNameofasb, eventNameofdevice, eventIsserios) {
                    const response = await fetch("api/events", {
                        method: "PUT",
                        headers: { "Accept": "application/json", "Content-Type": "application/json" },
                        body: JSON.stringify({
                            id: parseInt(eventId, 10),
                            dateofevent: eventDateofevent,
                            nameofasb: parseInt(eventNameofasb, 10),
                            nameofdevice: eventNameofdevice,
                            isserios: eventIsserios
                            
                        })
                    });
                    if (response.ok === true) {
                        const event = await response.json();
                        
                        reset();
                        document.querySelector("tr[data-rowid='" + event.id + "']").replaceWith(row(event));
                    }
                }
                // Удаление пользователя
                async function DeleteEvent(id) {
                    const response = await fetch("/api/events/" + id, {
                        method: "DELETE",
                        headers: { "Accept": "application/json" }
                    });
                    if (response.ok === true) {
                        const event = await response.json();
                        document.querySelector("tr[data-rowid='" + event.id + "']").remove();
                    }
                }
         
                // сброс формы
                 function reset() {
                    const form = document.forms["eventForm"];
                    form.reset();
                    form.elements["id"].value = 0;
                    
                } 
                // создание строки для таблицы
                function row(event) {
     
                    const tr = document.createElement("tr");
                    tr.setAttribute("data-rowid", event.id);

                    const idTd = document.createElement("td");
                    idTd.append(event.id);
                    tr.append(idTd);

                    const dateofeventTd = document.createElement("td");
                    dateofeventTd.append(event.dateofevent);
                    tr.append(dateofeventTd);

                    const nameofasbTd = document.createElement("td");
                    nameofasbTd.append(event.nameofasb);
                    tr.append(nameofasbTd);

                    const nameofdeviceTd = document.createElement("td");
                    nameofdeviceTd.append(event.nameofdevice);
                    tr.append(nameofdeviceTd);

                    const isseriosTd = document.createElement("td");
                    isseriosTd.append(event.isserios);
                    tr.append(isseriosTd);
      
                    /* const linksTd = document.createElement("td");

                    const editLink = document.createElement("a");
                    editLink.setAttribute("data-id", event.id);
                    editLink.setAttribute("style", "cursor:pointer;padding:15px;");
                    editLink.append("Изменить");
                    editLink.addEventListener("click", e => {

                        e.preventDefault();
                        GetEvent(event.id);
                    });
                    linksTd.append(editLink);

                    const removeLink = document.createElement("a");
                    removeLink.setAttribute("data-id", event.id);
                    removeLink.setAttribute("style", "cursor:pointer;padding:15px;");
                    removeLink.append("Удалить");
                    removeLink.addEventListener("click", e => {

                        e.preventDefault();
                        DeleteEvent(event.id);
                    });

                    linksTd.append(removeLink);
                    tr.appendChild(linksTd); */

                     return tr;
                }
                // сброс значений формы
                const resetbut = document.getElementById("reset");
                resetbut.onclick = function(e){
                    e.preventDefault();
                    reset();
                }

               
                // отправка формы
                document.forms["eventForm"].addEventListener("submit", e => {
                    e.preventDefault();
                    const form = document.forms["eventForm"];
                    const id = form.elements["id"].value;
                    const dateofevent = form.elements["dateofevent"].value;
                    const nameofasb = form.elements["nameofasb"].value;
                    const nameofdevice = form.elements["nameofdevice"].value;
                    const isserios = form.elements["isserios"].value;
                    
                    if (id == 0)
                        CreateEvent(dateofevent, nameofasb, nameofdevice, isserios);
                    else
                        EditEvent(id, dateofevent, nameofasb, nameofdevice, isserios);
                });
         
                
                
            </script>

        </div>
    </body>
</html>